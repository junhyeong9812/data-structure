# 20. ì¼ê´€ëœ í•´ì‹± (Consistent Hashing)

## ğŸ“‹ ë¬¸ì œ ì •ì˜

**ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œ ë…¸ë“œ ì¶”ê°€/ì œê±° ì‹œ ìµœì†Œí•œì˜ í‚¤ ì¬ë°°ì¹˜**ë¥¼ ë³´ì¥í•˜ëŠ” 
ì¼ê´€ëœ í•´ì‹± ì•Œê³ ë¦¬ì¦˜ì„ êµ¬í˜„í•˜ì„¸ìš”.

ì¼ê´€ëœ í•´ì‹±ì€ ë¶„ì‚° ìºì‹œ, ë¡œë“œ ë°¸ëŸ°ì„œ, ë¶„ì‚° ë°ì´í„°ë² ì´ìŠ¤ ë“±ì—ì„œ 
ë°ì´í„°ë¥¼ ì—¬ëŸ¬ ë…¸ë“œì— ê· ë“±í•˜ê²Œ ë¶„ë°°í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.

---

## ğŸ¯ í•™ìŠµ ëª©í‘œ

- ì¼ê´€ëœ í•´ì‹±ì˜ ì›ë¦¬ì™€ í•„ìš”ì„±
- í•´ì‹œ ë§(Hash Ring) êµ¬ì¡°
- ê°€ìƒ ë…¸ë“œ(Virtual Nodes)ë¥¼ í†µí•œ ë¶€í•˜ ë¶„ì‚°
- ë…¸ë“œ ì¶”ê°€/ì œê±° ì‹œ í‚¤ ì¬ë°°ì¹˜ ìµœì†Œí™”
- ë¶„ì‚° ì‹œìŠ¤í…œ ì„¤ê³„ ì›ë¦¬

---

## ğŸ“ ìš”êµ¬ì‚¬í•­

### í•µì‹¬ ê°œë…

| ê°œë… | ì„¤ëª… |
|------|------|
| **Hash Ring** | í•´ì‹œ ê°’ì„ ì›í˜•ìœ¼ë¡œ ë°°ì¹˜í•œ êµ¬ì¡° |
| **Physical Node** | ì‹¤ì œ ì„œë²„/ë…¸ë“œ |
| **Virtual Node** | ë¶€í•˜ ë¶„ì‚°ì„ ìœ„í•œ ê°€ìƒ ë…¸ë“œ |
| **Key Routing** | í‚¤ë¥¼ ë‹´ë‹¹ ë…¸ë“œë¡œ ë¼ìš°íŒ… |

### ê¸°ë³¸ ì—°ì‚°

| ë©”ì„œë“œ | ì„¤ëª… |
|--------|------|
| `addNode(node)` | ë…¸ë“œ ì¶”ê°€ |
| `removeNode(node)` | ë…¸ë“œ ì œê±° |
| `getNode(key)` | í‚¤ë¥¼ ë‹´ë‹¹í•˜ëŠ” ë…¸ë“œ ë°˜í™˜ |
| `getNodes(key, count)` | ë³µì œë¥¼ ìœ„í•œ ë‹¤ì¤‘ ë…¸ë“œ ë°˜í™˜ |

### ì„¤ì • ì˜µì…˜

| ì„¤ì • | ì„¤ëª… | ê¸°ë³¸ê°’ |
|------|------|--------|
| `virtualNodeCount` | ë…¸ë“œë‹¹ ê°€ìƒ ë…¸ë“œ ìˆ˜ | 150 |
| `hashFunction` | í•´ì‹œ í•¨ìˆ˜ | MD5/MurmurHash |

---

## ğŸ“Š ì…ì¶œë ¥ ì˜ˆì‹œ

### ì˜ˆì œ 1: ê¸°ë³¸ ì‚¬ìš©
```java
ConsistentHashing ch = new ConsistentHashing(100);  // ê°€ìƒ ë…¸ë“œ 100ê°œ

// ë…¸ë“œ ì¶”ê°€
ch.addNode("server1");
ch.addNode("server2");
ch.addNode("server3");

// í‚¤ ë¼ìš°íŒ…
String server = ch.getNode("user:123");  // "server2"
String server = ch.getNode("user:456");  // "server1"
String server = ch.getNode("user:789");  // "server3"
```

### ì˜ˆì œ 2: í•´ì‹œ ë§ ì‹œê°í™”
```
í•´ì‹œ ë§ (0 ~ 2^32-1):

                    0
                    â”‚
         server2-v1 â—â”€â”€â”€â”€â”€â”€â— server1-v2
                   /          \
                  /            \
    server3-v2  â—              â— server2-v2
                â”‚              â”‚
                â”‚              â”‚
    server1-v1  â—              â— server3-v1
                  \            /
                   \          /
         server2-v3 â—â”€â”€â”€â”€â”€â”€â— server1-v3
                    â”‚
                 2^32-1

í‚¤ "user:123" â†’ í•´ì‹œ â†’ ì‹œê³„ë°©í–¥ìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´ ë…¸ë“œ
```

### ì˜ˆì œ 3: ë…¸ë“œ ì¶”ê°€ ì‹œ í‚¤ ì¬ë°°ì¹˜
```
Before: 3 nodes
Keys distribution: Aâ†’server1, Bâ†’server2, Câ†’server3, Dâ†’server1

After: add server4
Keys distribution: Aâ†’server1, Bâ†’server4, Câ†’server3, Dâ†’server1
                               â†‘
                           Bë§Œ ì´ë™! (ìµœì†Œ ì¬ë°°ì¹˜)
```

### ì˜ˆì œ 4: ë³µì œ ë…¸ë“œ ê°€ì ¸ì˜¤ê¸°
```java
// ë³µì œë¥¼ ìœ„í•´ 3ê°œ ë…¸ë“œ ê°€ì ¸ì˜¤ê¸°
List<String> nodes = ch.getNodes("user:123", 3);
// ["server2", "server3", "server1"]  // ì‹œê³„ë°©í–¥ìœ¼ë¡œ 3ê°œ
```

---

## ğŸ” í•µì‹¬ ê°œë…

### ì¼ë°˜ í•´ì‹± vs ì¼ê´€ëœ í•´ì‹±
```
ì¼ë°˜ í•´ì‹± (Modulo):
node = hash(key) % N

ë¬¸ì œ: Nì´ ë³€ê²½ë˜ë©´ ê±°ì˜ ëª¨ë“  í‚¤ ì¬ë°°ì¹˜!
N=3 â†’ N=4: ~75% í‚¤ ì´ë™


ì¼ê´€ëœ í•´ì‹±:
node = ì‹œê³„ë°©í–¥ìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´ ë…¸ë“œ

ì¥ì : ë…¸ë“œ ë³€ê²½ ì‹œ ~K/N í‚¤ë§Œ ì´ë™ (K=ì „ì²´ í‚¤, N=ë…¸ë“œ ìˆ˜)
N=3 â†’ N=4: ~25% í‚¤ ì´ë™
```

### ê°€ìƒ ë…¸ë“œ í•„ìš”ì„±
```
ê°€ìƒ ë…¸ë“œ ì—†ì´:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  server1      server2      server3  â”‚
â”‚     â—            â—            â—     â”‚
â”‚     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚     33%          33%          33%   â”‚  â† ì´ìƒì 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ì‹¤ì œë¡œëŠ” í•´ì‹œ ë¶„í¬ê°€ ë¶ˆê· ë“±í•  ìˆ˜ ìˆìŒ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  s1  server2              server3   â”‚
â”‚  â—     â—                     â—      â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
â”‚  10%   15%                   75%    â”‚  â† ë¶ˆê· ë“±!
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ê°€ìƒ ë…¸ë“œ ì‚¬ìš© (ê° ë…¸ë“œë‹¹ 3ê°œ):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ s1 s2 s3 s1 s2 s3 s1 s2 s3         â”‚
â”‚  â—  â—  â—  â—  â—  â—  â—  â—  â—         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â†’ ë¶„í¬ê°€ ê· ë“±í•´ì§!
```

---

## ğŸ’¡ íŒíŠ¸

### ê¸°ë³¸ êµ¬ì¡°
```java
public class ConsistentHashing {
    private final TreeMap<Long, String> ring = new TreeMap<>();
    private final Map<String, Set<Long>> nodePositions = new HashMap<>();
    private final int virtualNodeCount;
    private final HashFunction hashFunction;
    
    public ConsistentHashing(int virtualNodeCount) {
        this.virtualNodeCount = virtualNodeCount;
        this.hashFunction = new MD5HashFunction();
    }
}
```

### ë…¸ë“œ ì¶”ê°€
```java
public void addNode(String node) {
    Set<Long> positions = new HashSet<>();
    
    for (int i = 0; i < virtualNodeCount; i++) {
        String virtualKey = node + "#" + i;
        long hash = hashFunction.hash(virtualKey);
        ring.put(hash, node);
        positions.add(hash);
    }
    
    nodePositions.put(node, positions);
}
```

### í‚¤ ë¼ìš°íŒ…
```java
public String getNode(String key) {
    if (ring.isEmpty()) {
        return null;
    }
    
    long hash = hashFunction.hash(key);
    
    // ì‹œê³„ë°©í–¥ìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´ ë…¸ë“œ
    Map.Entry<Long, String> entry = ring.ceilingEntry(hash);
    
    if (entry == null) {
        // ë§ì˜ ëì„ ë„˜ì–´ê°€ë©´ ì²˜ìŒìœ¼ë¡œ
        entry = ring.firstEntry();
    }
    
    return entry.getValue();
}
```

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] í•´ì‹œ ë§ êµ¬í˜„ (TreeMap)
- [ ] ë…¸ë“œ ì¶”ê°€/ì œê±°
- [ ] í‚¤ ë¼ìš°íŒ…
- [ ] ê°€ìƒ ë…¸ë“œ ì§€ì›
- [ ] ë‹¤ì¤‘ ë…¸ë“œ ë°˜í™˜ (ë³µì œìš©)
- [ ] ê°€ì¤‘ì¹˜ ê¸°ë°˜ ë…¸ë“œ (ì„ íƒ)
- [ ] ì»¤ìŠ¤í…€ í•´ì‹œ í•¨ìˆ˜ (ì„ íƒ)

---

## ğŸ“š ì°¸ê³ 

- Amazon Dynamo ë…¼ë¬¸
- Apache Cassandraì˜ íŒŒí‹°ì…”ë‹
- Memcached/Redis í´ëŸ¬ìŠ¤í„°
- [Consistent Hashing Visualization](https://www.toptal.com/big-data/consistent-hashing)
